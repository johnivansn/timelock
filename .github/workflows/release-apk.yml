name: Release APK

on:
  release:
    types: [published]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > android/keystore/release.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storeFile=keystore/release.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Install dependencies
        run: flutter pub get

      - name: Generate launcher icons
        run: flutter pub run flutter_launcher_icons

      - name: Derive version from tag
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ "$TAG" =~ ^v([0-9]{2})\.([0-9]{2})\.([0-9]+)(-.+)?$ ]]; then
            YY="${BASH_REMATCH[1]}"
            MM="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
          else
            echo "Invalid release tag format: $TAG"
            echo "Expected: vYY.MM.PATCH or vYY.MM.PATCH-<suffix>"
            exit 1
          fi
          VERSION_NAME="${YY}.${MM}.${PATCH}"
          VERSION_CODE=$((10#$YY * 10000 + 10#$MM * 100 + PATCH))
          echo "VERSION_NAME=$VERSION_NAME" >> "$GITHUB_ENV"
          echo "VERSION_CODE=$VERSION_CODE" >> "$GITHUB_ENV"
          echo "Using build versionName=$VERSION_NAME versionCode=$VERSION_CODE"

      - name: Build release APK
        run: flutter build apk --release --build-name "$VERSION_NAME" --build-number "$VERSION_CODE"

      - name: Generate SHA256
        run: |
          cd build/app/outputs/flutter-apk
          sha256sum app-release.apk > app-release.apk.sha256

      - name: Rename APK
        run: |
          cd build/app/outputs/flutter-apk
          mv app-release.apk timelock-${{ github.ref_name }}.apk
          mv app-release.apk.sha256 timelock-${{ github.ref_name }}.apk.sha256

      - name: Upload APK to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.ref_name }}" \
            build/app/outputs/flutter-apk/timelock-${{ github.ref_name }}.apk \
            build/app/outputs/flutter-apk/timelock-${{ github.ref_name }}.apk.sha256 \
            --clobber
